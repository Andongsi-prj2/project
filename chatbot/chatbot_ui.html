<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Gemini 챗봇 위젯</title>
  <style>
    /* 도우미 얼굴 아이콘 버튼 */
    #chatbot-icon {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: transparent;
      color: #333;
      border: none;
      border-radius: 0;
      width: 120px;
      height: 120px;
      font-size: 24px;
      cursor: pointer;
      z-index: 999;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #chatbot-icon:hover {
      transform: scale(1.1);
    }
    
    /* 말하는 애니메이션 - 입만 움직임 */
    .speaking {
      animation: speak 0.3s infinite alternate;
    }
    
    @keyframes speak {
      0% { 
        content: "😀";
      }
      50% {
        content: "😮";
      }
      100% { 
        content: "😀";
      }
    }
    
    /* 파이프 얼굴 이미지 */
    #chatbot-icon img {
      width: 120px;
      height: 120px;
      border-radius: 0;
      display: block;
      object-fit: contain;
      background: transparent;
      filter: brightness(1.1) contrast(1.2);
      mix-blend-mode: multiply;
    }

    /* 챗봇 창 */
    #chatbot-window {
      display: none;
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 300px;
      height: 400px;
      background-color: white;
      border: 1px solid #ccc;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      border-radius: 10px;
      z-index: 999;
      overflow: hidden;
      flex-direction: column;
    }

    #chat-box {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
    }

    #chat-input {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ccc;
    }

    #chat-input input {
      flex: 1;
      padding: 5px;
      font-size: 14px;
    }

    #chat-input button {
      margin-left: 5px;
    }
  </style>
</head>
<body>

<!-- 도우미 얼굴 아이콘 -->
<button id="chatbot-icon">
  <img src="image.png" alt="파이프 도우미" id="chatbot-image">
</button>

<!-- 챗봇 창 -->
<div id="chatbot-window">
  <div id="chat-box"></div>
  <div id="chat-input">
    <input type="text" id="user-input" placeholder="질문을 입력하세요">
    <button onclick="sendMessage()">전송</button>
  </div>
</div>

<script>
  // API 키들 (예비용 포함)
  const API_KEYS = [
    "AIzaSyBs8v-oDxyJZ-d3WPn9jUFBz5RR7r2AQwE",  // 첫 번째 API 키
    "AIzaSyDfmxMXRNlCJ38YsakRNjEM5KcrJt3CDIQ"   // 두 번째 API 키 (예비)
  ];
  let currentApiKeyIndex = 0;  // 현재 사용 중인 API 키 인덱스

  // 현재 시간을 가져오는 함수
  function getCurrentTime() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    const displayHours = hours % 12 || 12;
    const displayMinutes = minutes.toString().padStart(2, '0');
    return `${displayHours}:${displayMinutes} ${ampm}`;
  }

  // 아이콘 클릭 시 챗봇 창 토글
  document.getElementById("chatbot-icon").addEventListener("click", () => {
    const chatbotWindow = document.getElementById("chatbot-window");
    const userInput = document.getElementById("user-input");
    const chatBox = document.getElementById("chat-box");
    
    chatbotWindow.style.display = chatbotWindow.style.display === "none" ? "flex" : "none";
    
    // 챗봇 창이 열리면 환영 메시지 표시
    if (chatbotWindow.style.display === "flex") {
      // 채팅창이 비어있을 때만 환영 메시지 표시
      if (chatBox.innerHTML === "") {
        const currentTime = getCurrentTime();
        chatBox.innerHTML += `<div style="text-align: center; color: #666; font-size: 12px; margin: 10px 0;">오늘 ${currentTime}</div>`;
        chatBox.innerHTML += `<div><b><img src="image.png" style="width: 20px; height: 20px; border-radius: 50%; vertical-align: middle; margin-right: 5px;"> Chatbot:</b> 안녕하세요! 무엇을 도와드릴까요?</div>`;
      }
      
      setTimeout(() => {
        userInput.focus();
      }, 100);
    }
  });

    // 엔터키 입력 기능
  document.getElementById("user-input").addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
      sendMessage();
    }
  });

  // API 호출 함수 (자동 API 키 전환)
  async function callGeminiAPI(message) {
    for (let i = 0; i < API_KEYS.length; i++) {
      try {
        const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=" + API_KEYS[i], {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            contents: [{ parts: [{ text: message }] }]
          })
        });

        const data = await response.json();
        
        // API 키가 성공적으로 작동하면 현재 인덱스 업데이트
        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
          currentApiKeyIndex = i;
          return data.candidates[0].content.parts[0].text;
        }
        
        // 응답이 있지만 에러인 경우
        if (data.error) {
          console.log(`API 키 ${i + 1} 오류:`, data.error.message);
          continue; // 다음 API 키 시도
        }
        
      } catch (error) {
        console.log(`API 키 ${i + 1} 연결 실패:`, error.message);
        continue; // 다음 API 키 시도
      }
    }
    
    // 모든 API 키가 실패한 경우
    return "❌ 모든 API 키가 사용 불가능합니다. 잠시 후 다시 시도해주세요.";
  }

  async function sendMessage() {
    const input = document.getElementById("user-input");
    const message = input.value.trim();
    if (!message) return;

    const chatBox = document.getElementById("chat-box");
    const chatbotIcon = document.getElementById("chatbot-icon");
    
    const currentTime = getCurrentTime();
    chatBox.innerHTML += `<div style="text-align: right;"><div style="display: inline-block; background-color: #e3f2fd; padding: 8px 12px; border-radius: 15px; max-width: 70%;"><b>나:</b> ${message}</div><div style="text-align: right; color: #666; font-size: 10px; margin-top: 2px;">${currentTime}</div></div>`;
    input.value = "";

    // 도우미가 말하기 시작하는 애니메이션
    chatbotIcon.classList.add("speaking");
    
    // 애니메이션 제거 - 깜빡임 방지

    // API 호출 (자동 전환 포함)
    const reply = await callGeminiAPI(message);
    const replyTime = getCurrentTime();
    chatBox.innerHTML += `<div style="text-align: left;"><div style="display: inline-block; background-color: #f5f5f5; padding: 8px 12px; border-radius: 15px; max-width: 70%;"><b><img src="image.png" style="width: 20px; height: 20px; border-radius: 50%; vertical-align: middle; margin-right: 5px;"> Chatbot:</b> ${reply}</div><div style="text-align: left; color: #666; font-size: 10px; margin-top: 2px;">${replyTime}</div></div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
    
    // 말하기 애니메이션 종료
    chatbotIcon.classList.remove("speaking");
  }
</script>
</body>
</html>
